"use strict";!function(t,i){"function"==typeof define&&define.amd?define(["leaflet"],t):"object"==typeof exports&&(module.exports=t(require("leaflet"))),void 0!==i&&i.L&&(i.L.CanvasIconLayer=t(L))}(function(t){var i=(t.Layer?t.Layer:t.Class).extend({initialize:function(i){this.imageCache={},this._zIndex=0,t.setOptions(this,i)},setOptions:function(i){return t.setOptions(this,i),this._canvas&&this._updateOptions(),this.redraw()},redraw:function(){this._redraw(!0)},addMarker:function(i){t.Util.stamp(i),this._markers||(this._markers={}),this._markers[i._leaflet_id]=i;i.on("move",this._scheduleRedraw,this),this._drawMarker(i)},_scheduleRedraw:function(){if(!this._frame){var i=this;this._frame=t.Util.requestAnimFrame(function(){i._redraw(!0)})}},addLayer:function(t){"markerPane"==t.options.pane&&t.options.icon?this.addMarker(t):console.error("Layer isn't a marker")},removeLayer:function(t){this.removeMarker(t,!0)},removeMarker:function(t,i){delete this._markers[t._leaflet_id],i&&this._redraw(!0)},onAdd:function(t){this._map=t,this._onClickListeners=[],this._canvas||this._initCanvas(),this.options.pane?this.getPane().appendChild(this._canvas):t._panes.overlayPane.appendChild(this._canvas),t.on("move",this._reset,this),t.on("zoom",this._reset,this),t.on("click",this._executeClickListeners,this),t.on("mousemove",this._updateMouseCursor,this)},onRemove:function(t){this.options.pane?this.getPane().removeChild(this._canvas):t.getPanes().overlayPane.removeChild(this._canvas)},addTo:function(t){return t.addLayer(this),this},_drawMarker:function(t){var i=this,o=this._map.latLngToContainerPoint(t.getLatLng());if(t.options.icon){var n=t.options.icon.options.iconUrl;if(this.imageCache[n])this.imageCache[n]&&this.imageCache[n].complete&&0!==this.imageCache[n].naturalWidth&&i._drawImage(t,o);else{i=this;this.imageCache[n]=new Image,this.imageCache[n].onload=function(){i._scheduleRedraw()},this.imageCache[n].src=n}}},_drawImage:function(t,i){this._context.globalAlpha=t.options.opacity,t._zIndex=this._zIndex++;var o=t.options.icon.options.iconSize[0],n=t.options.icon.options.iconSize[1];i.x<2*-o||i.y<2*-n||i.x>this._canvas.width+2*o||i.y>this._canvas.height+2*n||(t.options.icon.options.iconOrigin?this._context.drawImage(this.imageCache[t.options.icon.options.iconUrl],t.options.icon.options.iconOrigin[0],t.options.icon.options.iconOrigin[1],t.options.icon.options.iconSize[0],t.options.icon.options.iconSize[1],i.x-t.options.icon.options.iconAnchor[0],i.y-t.options.icon.options.iconAnchor[1],t.options.icon.options.iconSize[0],t.options.icon.options.iconSize[1]):this._context.drawImage(this.imageCache[t.options.icon.options.iconUrl],i.x-t.options.icon.options.iconAnchor[0],i.y-t.options.icon.options.iconAnchor[1],t.options.icon.options.iconSize[0],t.options.icon.options.iconSize[1]))},_reset:function(){var i=this._map.containerPointToLayerPoint([0,0]);t.DomUtil.setPosition(this._canvas,i);var o=this._map.getSize();this._canvas.width=o.x,this._canvas.height=o.y,this._redraw()},_redraw:function(t){this._frame=null,this._zIndex=0,this._map&&(t&&this._context.clearRect(0,0,this._canvas.width,this._canvas.height),this._markers&&Object.keys(this._markers).forEach(function(t){this._drawMarker(this._markers[t])},this))},_initCanvas:function(){this._canvas=t.DomUtil.create("canvas","leaflet-canvas-icon-layer leaflet-layer"),this._canvas.style.zIndex=600;var i=this._map.getSize();this._canvas.width=i.x,this._canvas.height=i.y,this._context=this._canvas.getContext("2d");var o=this._map.options.zoomAnimation&&t.Browser.any3d;if(t.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(o?"animated":"hide")),o){var n=this;map.on("zoomanim",function(t){n._animateZoom(t)})}},_updateOptions:function(){},_executeClickListeners:function(t){var i=null;for(var o in this._markers){var n=this._markers[o],e=this._map.latLngToContainerPoint(this._markers[o].getLatLng());this._hit(n,e,t)&&n.options.opacity>0&&(!i||n._zIndex>i._zIndex)&&(i=n)}i&&i.fire("click")},_updateMouseCursor:function(t){var i=null;for(var o in this._markers){var n=this._markers[o],e=this._map.latLngToContainerPoint(this._markers[o].getLatLng());n.options.opacity>0&&n.options.icon&&this._hit(n,e,t)&&(!i||n._zIndex>i._zIndex)&&(i=n)}i?(this._map._container.style.cursor="pointer",i.options.title&&this._showTooltip(i)):(this._map._container.style.cursor="",this._hideTooltip())},_showTooltip(t){this._tooltip||(this._tooltip=document.createElement("div"),this._tooltip.className="leaflet-canvas-tooltip",this._canvas.parentNode.insertBefore(this._tooltip,this._canvas.nextSibling)),this._tooltip.style.display="block";var i=this._map.latLngToContainerPoint(t.getLatLng());this._tooltip.style.left=i.x+"px",this._tooltip.style.top=i.y+"px",this._tooltip.style.transform=this._canvas.style.transform,this._tooltip.style.zIndex=700,this._tooltip.innerText=t.options.title},_hideTooltip(){this._tooltip&&(this._tooltip.style.display="none")},_hit:function(t,i,o){if(t.options.icon){var n=t.options.icon.options.iconSize[0],e=t.options.icon.options.iconSize[1],s=t.options.icon.options.iconAnchor[0],a=t.options.icon.options.iconAnchor[1],r=o.containerPoint.x,c=o.containerPoint.y;return r>=i.x-s&&r<=i.x-s+n&&c>=i.y-a&&c<=i.y-a+e}return!1},_setTransform:function(i,o,n){var e=o||new t.Point(0,0);i.style[t.DomUtil.TRANSFORM]=(t.Browser.ie3d?"translate("+e.x+"px,"+e.y+"px)":"translate3d("+e.x+"px,"+e.y+"px,0)")+(n?" scale("+n+")":"")},_animateZoom:function(i){var o=this._map.getZoomScale(i.zoom),n=t.Layer?this._map._latLngBoundsToNewLayerBounds(this._map.getBounds(),i.zoom,i.center).min:this._map._getCenterOffset(i.center)._multiplyBy(-o).subtract(this._map._getMapPanePos());t.DomUtil.setTransform(this._canvas,n,o)}});t.canvasIconLayer=function(t){return new i(t)}},window);